name: 节点真测速筛选-轻量版

on:
  push:
    paths:
      - 'tester_v2.py'
      - '.github/workflows/speedtest.yml'
  workflow_run:
    workflows: ["自动抓取节点"] # 确保与抓取脚本的 YML name 匹配
    types: [completed]
  workflow_dispatch:

jobs:
  speedtest:
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 安装 Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: 下载测速二进制工具
        run: |
          # 使用 Stilleshan 维护的可直接运行版本
          wget -q https://github.com/stilleshan/lite-speedtest-docker/raw/main/lite-speedtest
          chmod +x lite-speedtest

      - name: 执行二进制真测速
        run: |
          # 直接读取 nodes_list.txt 进行下载测速
          # -timeout 5: 5秒连不上就判定为死节点
          # -num 100: 并发100个提高速度
          ./lite-speedtest -test nodes_list.txt -out out.json -timeout 5 -num 100

      - name: 运行 Python 筛选
        run: python tester_v2.py

      - name: 推送结果
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Action"
          git add nodes_list.txt
          git commit -m "Speedtest: 剔除死节点和低速节点" || exit 0
          git push
